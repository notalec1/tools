<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Critical for ActivBoards: Prevent scaling/scrolling while drawing -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenFlipchart Studio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* =========================================
           1. THEME & LARGE SCREEN OPTIMIZATION
           ========================================= */
        :root {
            --bg-dark: #2d3436;
            --bg-panel: #ecf0f1;
            --accent: #e67e22; /* Promethean Orange */
            --accent-hover: #d35400;
            --header-height: 60px; /* Taller for easier touch */
            --sidebar-width: 240px;
            --z-canvas: 1;
            --z-overlay: 100;
            --z-ui: 500;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            overflow: hidden; /* No scrollbars ever */
            display: flex; flex-direction: column;
        }

        /* HEADER */
        header {
            height: var(--header-height);
            background: #34495e; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #2c3e50; z-index: var(--z-ui);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .brand { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        
        .toolbar-top button {
            background: #465a6e; border: 1px solid rgba(0,0,0,0.2);
            color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer;
            margin-left: 8px; font-size: 1rem; font-weight: 500;
            transition: background 0.2s;
        }
        .toolbar-top button:hover { background: var(--accent); }

        /* MAIN LAYOUT */
        #app-container {
            display: flex; flex: 1; position: relative;
            height: calc(100% - var(--header-height));
        }

        /* SIDEBAR (Pages) */
        #sidebar {
            width: var(--sidebar-width); background: var(--bg-panel);
            border-right: 1px solid #bdc3c7;
            display: flex; flex-direction: column; padding: 15px; overflow-y: auto;
            z-index: var(--z-ui);
        }
        .page-thumbnail {
            width: 100%; height: 140px; background: white;
            border: 4px solid #bdc3c7; margin-bottom: 15px;
            cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: #ddd; border-radius: 4px;
        }
        .page-thumbnail.active { border-color: var(--accent); }
        .page-num {
            position: absolute; bottom: 5px; right: 5px;
            background: var(--accent); color: white;
            width: 25px; height: 25px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; font-weight: bold;
        }

        /* CANVAS AREA */
        #canvas-stage {
            flex: 1; background-color: #95a5a6;
            position: relative; overflow: hidden;
            touch-action: none; /* KEY: Prevents pen from scrolling page */
        }

        /* FLOATING STUDIO TOOLBAR */
        #main-toolbar {
            position: absolute; top: 20px; right: 20px;
            width: 70px; /* Wider for big fingers */
            background: white;
            border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            padding: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 8px;
            z-index: var(--z-ui);
        }
        .tool-btn {
            width: 50px; height: 50px; /* Big targets */
            border: none; background: transparent;
            border-radius: 8px; cursor: pointer; color: #2c3e50; font-size: 1.4rem;
            transition: all 0.1s;
        }
        .tool-btn:hover { background: #dfe6e9; transform: scale(1.1); }
        .tool-btn.active { background: #ffeaa7; color: #d35400; border: 3px solid var(--accent); }
        .sep { width: 40px; height: 2px; background: #eee; margin: 5px 0; }

        /* COLORS / PROPERTIES */
        #properties-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 15px 25px; border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            z-index: var(--z-ui);
        }
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
        .color-swatch {
            width: 32px; height: 32px; border-radius: 4px; cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
        }
        .color-swatch.active { transform: scale(1.2); border: 3px solid #333; z-index: 2; }

        /* TRASH CAN (Drop Zone) */
        #trash-zone {
            position: absolute; bottom: 20px; right: 20px;
            width: 80px; height: 80px;
            background: rgba(231, 76, 60, 0.8);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 2rem;
            z-index: var(--z-ui);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        #trash-zone:hover { transform: scale(1.1); background: #c0392b; }

        /* OVERLAYS */
        #overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: var(--z-overlay); overflow: hidden;
        }
        .floating-tool {
            position: absolute; pointer-events: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: grab;
        }
        
        /* Specific Tools */
        .tool-dice {
            width: 100px; height: 100px; background: white;
            border-radius: 16px; border: 4px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold; cursor: pointer;
        }
        .tool-clock {
            padding: 15px; background: #222; color: #0f0; border-radius: 10px; border: 4px solid #555;
            text-align: center; font-family: monospace;
        }
        .tool-ruler {
            width: 600px; height: 90px; background: rgba(255,255,230,0.95);
            border: 1px solid #999; display: flex; align-items: flex-end;
        }
        .ruler-marks {
            width: 100%; height: 40px;
            background-image: repeating-linear-gradient(90deg, #333 0, #333 2px, transparent 2px, transparent 20px);
        }

        /* Laser Pointer Trail */
        .laser-trail { pointer-events: none; }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="brand"><i class="fas fa-chalkboard-teacher"></i> &nbsp; OpenFlipchart Studio</div>
        <div class="toolbar-top">
            <button onclick="app.toggleTool('ruler')"><i class="fas fa-ruler-horizontal"></i> Ruler</button>
            <button onclick="app.toggleTool('dice')"><i class="fas fa-dice"></i> Dice</button>
            <button onclick="app.toggleTool('clock')"><i class="fas fa-clock"></i> Timer</button>
            <span style="border-left:1px solid #aaa; margin:0 10px; height:20px;"></span>
            <button id="btn-import"><i class="fas fa-folder-open"></i> Import</button>
            <button id="btn-export"><i class="fas fa-save"></i> Save</button>
            <input type="file" id="file-input" hidden accept=".json">
        </div>
    </header>

    <div id="app-container">
        
        <!-- Sidebar -->
        <div id="sidebar">
            <button style="width:100%; padding:12px; background:var(--accent); color:white; border:none; cursor:pointer; font-size:1.1rem; border-radius:6px;" id="add-page-btn">
                <i class="fas fa-plus"></i> New Page
            </button>
            <div id="page-list" style="margin-top:20px;"></div>
        </div>

        <!-- Canvas Stage -->
        <div id="canvas-stage">
            <canvas id="c"></canvas>
            
            <!-- Tools Overlay -->
            <div id="overlay-layer"></div>

            <!-- Trash Can -->
            <div id="trash-zone" title="Drag here to delete"><i class="fas fa-trash-alt"></i></div>
        </div>

        <!-- Floating Toolbar -->
        <div id="main-toolbar">
            <button class="tool-btn active" id="tool-select" title="Select (V)"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="tool-pen" title="Pen (P)"><i class="fas fa-pen"></i></button>
            <button class="tool-btn" id="tool-highlighter" title="Highlighter"><i class="fas fa-highlighter"></i></button>
            <button class="tool-btn" id="tool-laser" title="Laser Pointer"><i class="fas fa-magic"></i></button>
            <button class="tool-btn" id="tool-eraser" title="Eraser"><i class="fas fa-eraser"></i></button>
            <div class="sep"></div>
            <button class="tool-btn" id="tool-rect" title="Rectangle"><i class="far fa-square"></i></button>
            <button class="tool-btn" id="tool-circle" title="Circle"><i class="far fa-circle"></i></button>
            <button class="tool-btn" id="tool-text" title="Text"><i class="fas fa-font"></i></button>
            <div class="sep"></div>
            <button class="tool-btn" id="tool-undo"><i class="fas fa-undo"></i></button>
            <button class="tool-btn" id="tool-redo"><i class="fas fa-redo"></i></button>
            <button class="tool-btn" id="tool-clear"><i class="fas fa-bomb"></i></button>
        </div>

        <!-- Properties Bar -->
        <div id="properties-bar">
            <!-- Colors -->
            <div class="color-grid">
                <div class="color-swatch active" style="background:#000000" data-color="#000000"></div>
                <div class="color-swatch" style="background:#7f8c8d" data-color="#7f8c8d"></div>
                <div class="color-swatch" style="background:#c0392b" data-color="#c0392b"></div>
                <div class="color-swatch" style="background:#e67e22" data-color="#e67e22"></div>
                <div class="color-swatch" style="background:#f1c40f" data-color="#f1c40f"></div>
                <div class="color-swatch" style="background:#27ae60" data-color="#27ae60"></div>
                <div class="color-swatch" style="background:#2980b9" data-color="#2980b9"></div>
                <div class="color-swatch" style="background:#8e44ad" data-color="#8e44ad"></div>
                <!-- Row 2 -->
                <div class="color-swatch" style="background:#ffffff" data-color="#ffffff"></div>
                <div class="color-swatch" style="background:#bdc3c7" data-color="#bdc3c7"></div>
                <div class="color-swatch" style="background:#e74c3c" data-color="#e74c3c"></div>
                <div class="color-swatch" style="background:#d35400" data-color="#d35400"></div>
                <div class="color-swatch" style="background:#f39c12" data-color="#f39c12"></div>
                <div class="color-swatch" style="background:#2ecc71" data-color="#2ecc71"></div>
                <div class="color-swatch" style="background:#3498db" data-color="#3498db"></div>
                <div class="color-swatch" style="background:#9b59b6" data-color="#9b59b6"></div>
            </div>

            <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-circle" style="font-size:0.5rem; color:#aaa;"></i>
                    <input type="range" id="size-slider" min="1" max="60" value="3" style="width:150px">
                    <i class="fas fa-circle" style="font-size:1.5rem; color:#aaa;"></i>
                </div>
                <select id="bg-select" style="padding:8px; border-radius:6px; font-size:1rem;">
                    <option value="white">White</option>
                    <option value="grid">Math Grid</option>
                    <option value="lines">Lined Paper</option>
                    <option value="blue">Promethean Blue</option>
                    <option value="black">Chalkboard</option>
                </select>
            </div>
        </div>
    </div>

    <!-- =========================================
         LOGIC
         ========================================= -->
    <script>
    class WhiteboardApp {
        constructor() {
            this.canvas = null;
            this.pages = []; 
            this.currentPageIndex = 0;
            this.undoStack = []; this.redoStack = [];
            this.historyProcessing = false;
            
            this.currentMode = 'select'; 
            this.currentColor = '#000000';
            this.currentSize = 3;
            this.activeTools = {}; // ruler, dice

            this.init();
        }

        init() {
            // 1. Initialize Fabric with optimizations
            this.canvas = new fabric.Canvas('c', {
                isDrawingMode: false, backgroundColor: '#ffffff', selection: true,
                perPixelTargetFind: true, // Better hit detection for transparency
                targetFindTolerance: 4
            });

            this.setupResponsiveCanvas();
            this.bindEvents();
            this.setupDragAndDrop();
            this.addNewPage();
            this.setTool('pen'); // Default start
        }

        /* --- DRAG AND DROP IMAGES --- */
        setupDragAndDrop() {
            const container = document.getElementById('app-container');
            
            container.addEventListener('dragover', (e) => { e.preventDefault(); });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if(file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        fabric.Image.fromURL(f.target.result, (img) => {
                            img.scaleToWidth(300);
                            img.set({ left: e.clientX - 250, top: e.clientY - 50 }); // adjust for sidebar
                            this.canvas.add(img);
                            this.canvas.setActiveObject(img);
                            this.saveState();
                            this.setTool('select');
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        /* --- HISTORY --- */
        saveState() {
            if(this.historyProcessing) return;
            if (this.undoStack.length > 30) this.undoStack.shift();
            this.undoStack.push(JSON.stringify(this.canvas.toJSON()));
            this.redoStack = [];
        }

        undo() {
            if (this.undoStack.length === 0) return;
            this.historyProcessing = true;
            this.redoStack.push(JSON.stringify(this.canvas.toJSON()));
            const state = this.undoStack.pop();
            this.canvas.loadFromJSON(state, () => {
                this.canvas.renderAll();
                this.historyProcessing = false;
                this.updateBrushSettings();
            });
        }

        redo() {
            if (this.redoStack.length === 0) return;
            this.historyProcessing = true;
            this.undoStack.push(JSON.stringify(this.canvas.toJSON()));
            const state = this.redoStack.pop();
            this.canvas.loadFromJSON(state, () => {
                this.canvas.renderAll();
                this.historyProcessing = false;
                this.updateBrushSettings();
            });
        }

        setupResponsiveCanvas() {
            const stage = document.getElementById('canvas-stage');
            new ResizeObserver(() => {
                this.canvas.setWidth(stage.clientWidth);
                this.canvas.setHeight(stage.clientHeight);
                this.canvas.renderAll();
                this.updateBackground();
            }).observe(stage);
        }

        /* --- TOOLS & MODES --- */
        setTool(mode) {
            // UI Update
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`tool-${mode}`);
            if(btn) btn.classList.add('active');

            this.currentMode = mode;
            this.canvas.isDrawingMode = false;
            this.canvas.selection = true;
            this.canvas.off('mouse:down');
            this.canvas.off('path:created'); // Clear laser listener

            if (mode === 'pen' || mode === 'highlighter' || mode === 'laser') {
                this.canvas.isDrawingMode = true;
                this.canvas.selection = false;
                this.updateBrushSettings();
            } 
            else if (mode === 'eraser') {
                this.canvas.isDrawingMode = true;
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                this.canvas.freeDrawingBrush.color = '#ffffff'; 
                this.canvas.freeDrawingBrush.width = 50;
            }
            else if (['rect','circle'].includes(mode)) {
                this.canvas.selection = false;
                this.canvas.defaultCursor = 'crosshair';
                this.setupShapeDrawer(mode);
            }
        }

        updateBrushSettings() {
            if (!this.canvas.freeDrawingBrush) return;
            const size = parseInt(this.currentSize, 10);

            if (this.currentMode === 'pen') {
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                this.canvas.freeDrawingBrush.color = this.currentColor;
                this.canvas.freeDrawingBrush.width = size;
                this.canvas.freeDrawingBrush.decimate = 2; // Smooth out shakey hands
            } 
            else if (this.currentMode === 'highlighter') {
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                const c = new fabric.Color(this.currentColor);
                this.canvas.freeDrawingBrush.color = c.setAlpha(0.3).toRgba();
                this.canvas.freeDrawingBrush.width = size * 4;
            }
            else if (this.currentMode === 'laser') {
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                this.canvas.freeDrawingBrush.color = 'red';
                this.canvas.freeDrawingBrush.width = 5;
                
                // Magic: Fade out immediately
                this.canvas.on('path:created', (e) => {
                    e.path.animate('opacity', 0, {
                        duration: 1000,
                        onChange: this.canvas.renderAll.bind(this.canvas),
                        onComplete: () => {
                            this.canvas.remove(e.path);
                        }
                    });
                });
            }
        }

        setupShapeDrawer(type) {
            let rect, isDown, origX, origY;
            this.canvas.on('mouse:down', (o) => {
                isDown = true;
                const p = this.canvas.getPointer(o.e);
                origX = p.x; origY = p.y;
                if (type === 'rect') {
                    rect = new fabric.Rect({ left: origX, top: origY, width:0, height:0, fill: this.currentColor });
                } else {
                    rect = new fabric.Circle({ left: origX, top: origY, radius:1, fill: this.currentColor });
                }
                this.canvas.add(rect);
            });
            this.canvas.on('mouse:move', (o) => {
                if(!isDown) return;
                const p = this.canvas.getPointer(o.e);
                if(type === 'rect') {
                    rect.set({ width: Math.abs(origX - p.x), height: Math.abs(origY - p.y) });
                    if(origX > p.x) rect.set({ left: p.x });
                    if(origY > p.y) rect.set({ top: p.y });
                } else {
                    rect.set({ radius: Math.abs(origX - p.x)/2 });
                    if(origX > p.x) rect.set({ left: p.x });
                }
                this.canvas.renderAll();
            });
            this.canvas.on('mouse:up', () => {
                isDown = false; rect.setCoords();
                this.saveState(); this.setTool('select');
            });
        }

        /* --- FLOATING CLASSROOM TOOLS --- */
        toggleTool(type) {
            const layer = document.getElementById('overlay-layer');
            if (this.activeTools[type]) {
                this.activeTools[type].remove();
                delete this.activeTools[type];
                return;
            }

            const el = document.createElement('div');
            el.className = `floating-tool tool-${type}`;
            el.style.left = '300px'; el.style.top = '200px';

            if (type === 'ruler') {
                el.innerHTML = `<div class="ruler-marks"></div>`;
            } 
            else if (type === 'dice') {
                el.innerHTML = '<i class="fas fa-dice-one"></i>';
                el.onclick = (e) => {
                    // Prevent drag
                    if(e.detail > 1) return; // ignore double click
                    const icons = ['one','two','three','four','five','six'];
                    let roll = 0;
                    const spin = setInterval(() => {
                        el.innerHTML = `<i class="fas fa-dice-${icons[roll%6]}"></i>`;
                        roll++;
                        if(roll > 10) {
                            clearInterval(spin);
                            const final = Math.floor(Math.random()*6);
                            el.innerHTML = `<i class="fas fa-dice-${icons[final]}" style="color:${this.currentColor}"></i>`;
                        }
                    }, 100);
                }
            }
            else if (type === 'clock') {
                el.innerHTML = `<h3>00:00</h3><button>Start/Stop</button><button onclick="this.parentElement.remove()">X</button>`;
                // Simplified clock logic for brevity
                let sec=0, int=null;
                el.querySelector('button').onclick = () => {
                    if(int) { clearInterval(int); int=null; }
                    else { int = setInterval(() => { sec++; el.querySelector('h3').innerText = new Date(sec*1000).toISOString().substr(14,5); }, 1000); }
                }
            }

            layer.appendChild(el);
            this.makeDraggable(el);
            this.activeTools[type] = el;
        }

        makeDraggable(el) {
            let isDragging = false, startX, startY, initLeft, initTop;
            el.addEventListener('mousedown', e => {
                if(e.target.tagName==='BUTTON') return;
                isDragging = true;
                startX = e.clientX; startY = e.clientY;
                initLeft = el.offsetLeft; initTop = el.offsetTop;
            });
            window.addEventListener('mousemove', e => {
                if(!isDragging) return;
                el.style.left = (initLeft + (e.clientX - startX)) + 'px';
                el.style.top = (initTop + (e.clientY - startY)) + 'px';
            });
            window.addEventListener('mouseup', () => isDragging = false);
        }

        /* --- PAGES & I/O --- */
        addNewPage() {
            if(this.pages.length > 0) this.pages[this.currentPageIndex] = this.canvas.toJSON();
            this.pages.push({ version: "5.3", objects: [], background: "#ffffff" });
            this.renderPageList();
            this.loadPage(this.pages.length - 1);
        }

        loadPage(idx) {
            this.pages[this.currentPageIndex] = this.canvas.toJSON();
            this.currentPageIndex = idx;
            this.canvas.loadFromJSON(this.pages[idx], () => {
                this.canvas.renderAll();
                this.updateUIForPage();
                this.undoStack = []; this.redoStack = [];
                this.setTool(this.currentMode);
            });
        }

        renderPageList() {
            const list = document.getElementById('page-list');
            list.innerHTML = '';
            this.pages.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = `page-thumbnail ${i===this.currentPageIndex?'active':''}`;
                d.innerHTML = `<span class="page-num">${i+1}</span>`;
                d.onclick = () => this.loadPage(i);
                list.appendChild(d);
            });
        }

        updateUIForPage() {
            document.querySelectorAll('.page-thumbnail').forEach((d,i) => {
                if(i===this.currentPageIndex) d.classList.add('active');
                else d.classList.remove('active');
            });
            this.updateBackground();
        }

        updateBackground() {
            const v = document.getElementById('bg-select').value;
            let bg = '#ffffff';
            if(v==='blue') bg = '#81ecec';
            if(v==='black') bg = '#2d3436';
            
            if(v==='grid' || v==='lines') {
                const c = document.createElement('canvas'); c.width=40; c.height=40;
                const ctx = c.getContext('2d'); ctx.strokeStyle = (v==='black'?'#555':'#ddd');
                ctx.beginPath();
                if(v==='grid') { ctx.moveTo(0,0); ctx.lineTo(40,0); ctx.moveTo(0,0); ctx.lineTo(0,40); }
                else { ctx.moveTo(0,39); ctx.lineTo(40,39); }
                ctx.stroke();
                this.canvas.setBackgroundColor(new fabric.Pattern({source:c, repeat:'repeat'}), this.canvas.renderAll.bind(this.canvas));
            } else {
                this.canvas.setBackgroundColor(bg, this.canvas.renderAll.bind(this.canvas));
            }
        }

        bindEvents() {
            // Trash Logic
            const trash = document.getElementById('trash-zone');
            this.canvas.on('object:moving', (e) => {
                // Check collision with trash (bottom right)
                const p = this.canvas.getPointer(e.e);
                const w = this.canvas.getWidth(), h = this.canvas.getHeight();
                if (p.x > w - 100 && p.y > h - 100) {
                    trash.style.transform = 'scale(1.2)';
                } else {
                    trash.style.transform = 'scale(1)';
                }
            });
            this.canvas.on('mouse:up', (e) => {
                const p = this.canvas.getPointer(e.e);
                const w = this.canvas.getWidth(), h = this.canvas.getHeight();
                if (p.x > w - 100 && p.y > h - 100) {
                    const active = this.canvas.getActiveObjects();
                    if(active.length) {
                        this.canvas.discardActiveObject();
                        active.forEach(a => this.canvas.remove(a));
                        trash.style.transform = 'scale(1)';
                        this.saveState();
                    }
                }
            });

            // Standard Bindings
            ['select','pen','highlighter','eraser','laser','rect','circle'].forEach(t => {
                document.getElementById(`tool-${t}`).onclick = () => this.setTool(t);
            });
            document.getElementById('tool-text').onclick = () => {
                const t = new fabric.IText('Text', { left:200, top:200, fill:this.currentColor, fontSize:60 });
                this.canvas.add(t); this.canvas.setActiveObject(t); this.setTool('select');
            };
            document.getElementById('tool-undo').onclick = () => this.undo();
            document.getElementById('tool-redo').onclick = () => this.redo();
            document.getElementById('tool-clear').onclick = () => {
                if(confirm('Clear Page?')) { this.canvas.clear(); this.updateBackground(); this.saveState(); }
            };

            // Colors
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.onclick = (e) => {
                    document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('active'));
                    e.target.classList.add('active');
                    this.currentColor = e.target.getAttribute('data-color');
                    
                    const active = this.canvas.getActiveObject();
                    if(active) {
                        active.set({fill:this.currentColor});
                        if(active.type==='path') active.set({stroke:this.currentColor});
                        this.canvas.renderAll(); this.saveState();
                    }
                    if(['pen','highlighter'].includes(this.currentMode)) this.updateBrushSettings();
                }
            });

            document.getElementById('size-slider').oninput = (e) => {
                this.currentSize = e.target.value; this.updateBrushSettings();
            };
            document.getElementById('bg-select').onchange = () => this.updateBackground();
            document.getElementById('add-page-btn').onclick = () => this.addNewPage();
            
            // I/O
            document.getElementById('btn-export').onclick = () => {
                this.pages[this.currentPageIndex] = this.canvas.toJSON();
                const blob = new Blob([JSON.stringify({pages:this.pages})], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download='lesson.json'; a.click();
            };
            const fi = document.getElementById('file-input');
            document.getElementById('btn-import').onclick = () => fi.click();
            fi.onchange = (e) => {
                const r = new FileReader();
                r.onload = (res) => {
                    try {
                        const d = JSON.parse(res.target.result);
                        if(d.pages) {
                            this.pages = d.pages; this.currentPageIndex=0;
                            this.renderPageList(); this.loadPage(0);
                        }
                    } catch(err) { alert('Load Error'); }
                };
                if(e.target.files[0]) r.readAsText(e.target.files[0]);
                e.target.value='';
            };

            // Canvas Observers
            this.canvas.on('object:added', () => this.saveState());
            this.canvas.on('object:modified', () => this.saveState());
            this.canvas.on('object:removed', () => this.saveState());
        }
    }

    window.onload = () => window.app = new WhiteboardApp();
    </script>
</body>
</html>
