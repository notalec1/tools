<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenBoard Ultimate</title>
    
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* =========================================
           1. ANIMATIONS & VARIABLES
           ========================================= */
        :root {
            --primary: #2d3436;
            --accent: #0984e3;
            --accent-hover: #74b9ff;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.2);
            --header-height: 60px;
            --sidebar-width: 240px;
            --anim-speed: 0.25s;
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; overflow: hidden; height: 100vh;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #dfe6e9;
            display: flex; flex-direction: column;
        }

        /* =========================================
           2. UI COMPONENTS
           ========================================= */
        
        /* Glassmorphism Header */
        header {
            height: var(--header-height);
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
            z-index: 1000;
        }

        .logo { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .logo i { color: #f1c40f; animation: float 3s ease-in-out infinite; }

        .top-toolbar { display: flex; gap: 8px; }
        .btn-top {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 8px 14px; border-radius: 8px; cursor: pointer;
            transition: all var(--anim-speed);
            display: flex; align-items: center; gap: 6px;
        }
        .btn-top:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .btn-top:active { transform: translateY(0); }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width); background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex; flex-direction: column;
            padding: 15px; overflow-y: auto;
            animation: slideInLeft 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .page-card {
            background: white; border-radius: 8px; height: 140px;
            margin-bottom: 15px; box-shadow: var(--shadow-sm);
            cursor: pointer; position: relative; border: 3px solid transparent;
            transition: all 0.2s; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            color: #bdc3c7; font-size: 2rem;
        }
        .page-card:hover { transform: scale(1.02); }
        .page-card.active { border-color: var(--accent); }
        .page-badge {
            position: absolute; bottom: 8px; right: 8px;
            background: var(--primary); color: white;
            padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;
        }

        /* Main Stage */
        #stage { flex: 1; position: relative; overflow: hidden; background: #95a5a6; }
        
        /* Floating Main Toolbar */
        #toolbar-main {
            position: absolute; top: 20px; right: 20px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 15px 10px; border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column; gap: 10px;
            z-index: 500;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .tool-btn {
            width: 48px; height: 48px; border-radius: 12px;
            border: none; background: transparent;
            color: var(--primary); font-size: 1.3rem;
            cursor: pointer; transition: all 0.2s;
            position: relative;
        }
        .tool-btn:hover { background: rgba(0,0,0,0.05); transform: scale(1.1); }
        .tool-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.4); }
        
        /* Tooltip */
        .tool-btn::after {
            content: attr(title); position: absolute; right: 60px; top: 12px;
            background: #2d3436; color: white; padding: 4px 8px;
            border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; white-space: nowrap;
        }
        .tool-btn:hover::after { opacity: 1; }

        /* Properties Bar (Bottom) */
        #prop-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 12px 25px; border-radius: 20px;
            box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 20px;
            z-index: 500;
            animation: popIn 0.4s 0.1s backwards;
        }

        .color-group { display: flex; gap: 8px; }
        .color-dot {
            width: 28px; height: 28px; border-radius: 50%;
            cursor: pointer; border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { transform: scale(1.3); border-color: var(--primary); }
        
        input[type="color"] {
            width: 32px; height: 32px; border: none; background: none; cursor: pointer;
        }

        /* Trash Zone */
        #trash {
            position: absolute; bottom: 20px; right: 20px;
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: var(--shadow-lg);
            z-index: 400; opacity: 0.6; transition: all 0.3s;
            transform: scale(0.8);
        }
        #trash.active { opacity: 1; transform: scale(1.1) rotate(15deg); }

        /* =========================================
           3. GADGETS & OVERLAYS
           ========================================= */
        #gadget-layer { position: absolute; inset: 0; pointer-events: none; z-index: 800; overflow: hidden; }
        .gadget { position: absolute; pointer-events: auto; cursor: grab; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3)); }
        .gadget:active { cursor: grabbing; }

        /* Ruler */
        .ruler {
            width: 500px; height: 80px; background: rgba(255,255,240, 0.95);
            border: 1px solid #aaa; border-radius: 4px;
            display: flex; align-items: flex-end;
            user-select: none;
        }
        .ruler-ticks {
            width: 100%; height: 40px;
            background: repeating-linear-gradient(90deg, #333 0, #333 1px, transparent 1px, transparent 10px);
        }

        /* Protractor */
        .protractor {
            width: 300px; height: 150px; background: rgba(255,255,255,0.5);
            border: 2px solid #333; border-radius: 150px 150px 0 0;
            display: flex; justify-content: center; align-items: flex-end;
        }
        .protractor::after { content:''; width:4px; height:4px; background:black; border-radius:50%; margin-bottom:10px; }

        /* Sticky Note */
        .sticky-note {
            width: 180px; height: 180px; background: #ffeaa7;
            padding: 15px; font-family: 'Comic Sans MS', cursive;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
            transform: rotate(-2deg); transition: transform 0.2s;
        }
        .sticky-note:hover { transform: rotate(0deg) scale(1.02); }
        .sticky-note textarea {
            width: 100%; height: 100%; background: transparent; border: none; resize: none; outline: none; font-size: 1.2rem;
        }

        /* Clock/Calculator */
        .panel-gadget {
            background: #2d3436; color: white; padding: 15px; border-radius: 12px;
            font-family: monospace; min-width: 200px; text-align: center;
        }
        .panel-gadget button {
            background: #636e72; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 4px; cursor: pointer;
        }
        .panel-gadget button:hover { background: var(--accent); }

        /* Dice */
        .dice-box { width: 80px; height: 80px; perspective: 1000px; cursor: pointer; }
        .dice { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .face {
            position: absolute; width: 80px; height: 80px; background: white; border: 2px solid #333; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
        }
        /* Simple mapping for visual dice */
        .face:nth-child(1) { transform: rotateY(0deg) translateZ(40px); }
        .face:nth-child(2) { transform: rotateY(180deg) translateZ(40px); }
        .face:nth-child(3) { transform: rotateY(90deg) translateZ(40px); }
        .face:nth-child(4) { transform: rotateY(-90deg) translateZ(40px); }
        .face:nth-child(5) { transform: rotateX(90deg) translateZ(40px); }
        .face:nth-child(6) { transform: rotateX(-90deg) translateZ(40px); }

        /* Spotlight/Curtain */
        #curtain, #spotlight {
            position: absolute; inset: 0; z-index: 700; pointer-events: auto; display: none;
        }
        #curtain { background: #2c3e50; height: 100%; transition: top 0.1s; }
        .curtain-handle {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 10px 20px; border-radius: 20px; cursor: ns-resize;
        }
        #spotlight { background: transparent; overflow: hidden; }
        .spotlight-hole {
            position: absolute; width: 250px; height: 250px; border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.95);
            cursor: move; border: 2px solid rgba(255,255,255,0.5);
        }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <i class="fas fa-layer-group"></i> OpenBoard Ultimate
        </div>
        <div class="top-toolbar">
            <button class="btn-top" onclick="gadgets.add('ruler')"><i class="fas fa-ruler-horizontal"></i> Ruler</button>
            <button class="btn-top" onclick="gadgets.add('protractor')"><i class="fas fa-drafting-compass"></i> Protractor</button>
            <button class="btn-top" onclick="gadgets.add('sticky')"><i class="fas fa-sticky-note"></i> Note</button>
            <button class="btn-top" onclick="gadgets.add('dice')"><i class="fas fa-dice"></i> Dice</button>
            <button class="btn-top" onclick="gadgets.add('clock')"><i class="fas fa-clock"></i> Clock</button>
            <button class="btn-top" onclick="gadgets.add('calc')"><i class="fas fa-calculator"></i> Calc</button>
            <div style="width:1px; background:rgba(255,255,255,0.3); margin:0 5px;"></div>
            <button class="btn-top" onclick="app.toggleCurtain()"><i class="fas fa-theater-masks"></i> Curtain</button>
            <button class="btn-top" onclick="app.toggleSpotlight()"><i class="fas fa-lightbulb"></i> Spotlight</button>
            <button class="btn-top" onclick="confetti({particleCount: 150, spread: 70, origin: { y: 0.6 }})"><i class="fas fa-gift"></i></button>
        </div>
        <div class="top-toolbar">
            <button class="btn-top" style="background:#27ae60" onclick="app.io.import()">Open</button>
            <button class="btn-top" style="background:#2980b9" onclick="app.io.export()">Save</button>
            <input type="file" id="file-input" hidden accept=".json">
        </div>
    </header>

    <div style="display: flex; flex:1; position:relative;">
        <div id="sidebar">
            <button class="btn-top" style="background:var(--accent); width:100%; justify-content:center; margin-bottom:15px;" onclick="app.pages.add()">+ New Slide</button>
            <div id="page-list"></div>
        </div>
        
        <div id="stage">
            <canvas id="c"></canvas>
            
            <!-- Overlays -->
            <div id="gadget-layer"></div>
            <div id="curtain"><div class="curtain-handle"><i class="fas fa-arrows-alt-v"></i> Drag</div></div>
            <div id="spotlight"><div class="spotlight-hole" style="top:30%; left:40%;"></div></div>
            <div id="trash"><i class="fas fa-trash"></i></div>
        </div>

        <!-- Floating Toolbars -->
        <div id="toolbar-main">
            <button class="tool-btn active" id="t-select" title="Select" onclick="app.tool.set('select')"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="t-pen" title="Pen" onclick="app.tool.set('pen')"><i class="fas fa-pen"></i></button>
            <button class="tool-btn" id="t-highlighter" title="Highlighter" onclick="app.tool.set('highlighter')"><i class="fas fa-highlighter"></i></button>
            <button class="tool-btn" id="t-eraser" title="True Eraser" onclick="app.tool.set('eraser')"><i class="fas fa-eraser"></i></button>
            <div style="height:1px; background:#ddd; margin:5px 0;"></div>
            <button class="tool-btn" id="t-rect" title="Rectangle" onclick="app.tool.set('rect')"><i class="far fa-square"></i></button>
            <button class="tool-btn" id="t-circle" title="Circle" onclick="app.tool.set('circle')"><i class="far fa-circle"></i></button>
            <button class="tool-btn" id="t-text" title="Text" onclick="app.tool.addText()"><i class="fas fa-font"></i></button>
            <div style="height:1px; background:#ddd; margin:5px 0;"></div>
            <button class="tool-btn" title="Undo" onclick="app.history.undo()"><i class="fas fa-undo"></i></button>
            <button class="tool-btn" title="Clear Page" onclick="app.pages.clear()"><i class="fas fa-bomb"></i></button>
        </div>

        <div id="prop-bar">
            <!-- Colors -->
            <div class="color-group">
                <div class="color-dot active" style="background:#2d3436" onclick="app.props.setColor('#2d3436', this)"></div>
                <div class="color-dot" style="background:#c0392b" onclick="app.props.setColor('#c0392b', this)"></div>
                <div class="color-dot" style="background:#2980b9" onclick="app.props.setColor('#2980b9', this)"></div>
                <div class="color-dot" style="background:#27ae60" onclick="app.props.setColor('#27ae60', this)"></div>
                <div class="color-dot" style="background:#e67e22" onclick="app.props.setColor('#e67e22', this)"></div>
                <div class="color-dot" style="background:#8e44ad" onclick="app.props.setColor('#8e44ad', this)"></div>
                <!-- Custom Picker -->
                <div style="position:relative; width:32px; height:32px; border-radius:50%; overflow:hidden; border:2px solid #ccc; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-plus" style="position:absolute; font-size:10px; pointer-events:none;"></i>
                    <input type="color" oninput="app.props.setColor(this.value, null)">
                </div>
            </div>

            <div style="width:1px; height:30px; background:#ccc;"></div>

            <!-- Size -->
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fas fa-circle" style="font-size:4px; color:#aaa;"></i>
                <input type="range" min="1" max="60" value="3" style="width:100px" oninput="app.props.setSize(this.value)">
                <i class="fas fa-circle" style="font-size:16px; color:#aaa;"></i>
            </div>

            <div style="width:1px; height:30px; background:#ccc;"></div>

            <!-- Backgrounds -->
            <select onchange="app.props.setBg(this.value)" style="padding:6px; border-radius:6px; border:1px solid #ccc;">
                <option value="white">White</option>
                <option value="grid">Grid</option>
                <option value="lines">Lined</option>
                <option value="black">Chalkboard</option>
                <option value="blue">Promethean</option>
            </select>
        </div>
    </div>

    <!-- =========================================
         APP LOGIC
         ========================================= -->
    <script>
    const app = {
        canvas: null,
        state: { color: '#2d3436', size: 3, tool: 'pen' },
        pages: [], pageIdx: 0,

        init() {
            // Setup Fabric
            this.canvas = new fabric.Canvas('c', {
                isDrawingMode: true, selection: false,
                backgroundColor: '#ffffff',
                perPixelTargetFind: true // Critical for eraser
            });

            // Resize Logic
            const resize = () => {
                const el = document.getElementById('stage');
                this.canvas.setWidth(el.clientWidth);
                this.canvas.setHeight(el.clientHeight);
                this.canvas.renderAll();
                this.props.setBg(document.querySelector('select').value);
            };
            window.onresize = resize;
            setTimeout(resize, 100);

            this.tool.set('pen');
            this.pages.add();
            this.bindEvents();
        },

        /* --- TOOLS --- */
        tool: {
            set(name) {
                app.state.tool = name;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById(`t-${name}`);
                if(btn) btn.classList.add('active');

                app.canvas.isDrawingMode = false;
                app.canvas.selection = true;
                app.canvas.off('mouse:down');

                if (name === 'pen') {
                    app.canvas.isDrawingMode = true;
                    app.canvas.selection = false;
                    app.canvas.freeDrawingBrush = new fabric.PencilBrush(app.canvas);
                    app.canvas.freeDrawingBrush.color = app.state.color;
                    app.canvas.freeDrawingBrush.width = app.state.size;
                }
                else if (name === 'highlighter') {
                    app.canvas.isDrawingMode = true;
                    app.canvas.selection = false;
                    app.canvas.freeDrawingBrush = new fabric.PencilBrush(app.canvas);
                    const c = new fabric.Color(app.state.color);
                    app.canvas.freeDrawingBrush.color = c.setAlpha(0.4).toRgba();
                    app.canvas.freeDrawingBrush.width = app.state.size * 4;
                }
                else if (name === 'eraser') {
                    // TRUE ERASER (Destination Out)
                    app.canvas.isDrawingMode = true;
                    app.canvas.freeDrawingBrush = new fabric.PencilBrush(app.canvas);
                    app.canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)'; // Color doesn't matter, opacity does
                    app.canvas.freeDrawingBrush.width = 40;
                    // Magic line:
                    app.canvas.freeDrawingBrush.globalCompositeOperation = 'destination-out';
                }
                else if (['rect', 'circle'].includes(name)) {
                    app.canvas.selection = false;
                    app.canvas.defaultCursor = 'crosshair';
                    this.initShape(name);
                }
            },
            initShape(type) {
                let rect, isDown, origX, origY;
                app.canvas.on('mouse:down', o => {
                    isDown = true;
                    const p = app.canvas.getPointer(o.e);
                    origX = p.x; origY = p.y;
                    if(type==='rect') rect = new fabric.Rect({left:origX, top:origY, width:0, height:0, fill:app.state.color});
                    else rect = new fabric.Circle({left:origX, top:origY, radius:0, fill:app.state.color});
                    app.canvas.add(rect);
                });
                app.canvas.on('mouse:move', o => {
                    if(!isDown) return;
                    const p = app.canvas.getPointer(o.e);
                    if(type==='rect') rect.set({ width: Math.abs(origX-p.x), height: Math.abs(origY-p.y) });
                    else rect.set({ radius: Math.abs(origX-p.x)/2 });
                    app.canvas.renderAll();
                });
                app.canvas.on('mouse:up', () => { isDown=false; app.tool.set('select'); app.history.save(); });
            },
            addText() {
                const t = new fabric.IText('Type here', { left:200, top:200, fill: app.state.color, fontSize: 40 });
                app.canvas.add(t); app.canvas.setActiveObject(t); app.tool.set('select');
            }
        },

        /* --- PROPERTIES --- */
        props: {
            setColor(hex, el) {
                app.state.color = hex;
                if(el) {
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    el.classList.add('active');
                }
                // Update active object
                const act = app.canvas.getActiveObject();
                if(act) { act.set({fill:hex}); app.canvas.renderAll(); app.history.save(); }
                
                // Refresh brush
                if(['pen','highlighter'].includes(app.state.tool)) app.tool.set(app.state.tool);
            },
            setSize(val) {
                app.state.size = parseInt(val, 10);
                if(app.canvas.freeDrawingBrush) app.canvas.freeDrawingBrush.width = app.state.size;
            },
            setBg(type) {
                let bg = '#ffffff';
                if(type === 'black') bg = '#2d3436';
                if(type === 'blue') bg = '#74b9ff';
                
                if(type === 'grid' || type === 'lines') {
                    const c = document.createElement('canvas'); c.width=40; c.height=40;
                    const ctx = c.getContext('2d'); ctx.strokeStyle='#ddd';
                    ctx.beginPath();
                    if(type==='grid') { ctx.moveTo(0,0); ctx.lineTo(40,0); ctx.moveTo(0,0); ctx.lineTo(0,40); }
                    else { ctx.moveTo(0,39); ctx.lineTo(40,39); }
                    ctx.stroke();
                    app.canvas.setBackgroundColor(new fabric.Pattern({source:c, repeat:'repeat'}), app.canvas.renderAll.bind(app.canvas));
                } else {
                    app.canvas.setBackgroundColor(bg, app.canvas.renderAll.bind(app.canvas));
                }
            }
        },

        /* --- HISTORY --- */
        history: {
            undoStack: [],
            save() {
                if(this.undoStack.length > 20) this.undoStack.shift();
                this.undoStack.push(JSON.stringify(app.canvas.toJSON()));
            },
            undo() {
                if(!this.undoStack.length) return;
                app.canvas.loadFromJSON(this.undoStack.pop(), () => {
                    app.canvas.renderAll();
                    // Restore brush because loadFromJSON kills it
                    app.tool.set(app.state.tool);
                });
            }
        },

        /* --- PAGES --- */
        pages: {
            add() {
                if(app.pages.length) app.pages[app.pageIdx] = app.canvas.toJSON();
                app.pages.push({});
                this.load(app.pages.length - 1);
            },
            load(idx) {
                if(app.pages[app.pageIdx]) app.pages[app.pageIdx] = app.canvas.toJSON();
                app.pageIdx = idx;
                app.canvas.loadFromJSON(app.pages[idx] || {}, () => {
                    app.canvas.renderAll();
                    app.tool.set(app.state.tool);
                    this.renderList();
                });
            },
            clear() {
                if(confirm("Clear Slide?")) { app.canvas.clear(); app.props.setBg(document.querySelector('select').value); }
            },
            renderList() {
                const div = document.getElementById('page-list'); div.innerHTML = '';
                app.pages.forEach((p, i) => {
                    const card = document.createElement('div');
                    card.className = `page-card ${i===app.pageIdx ? 'active' : ''}`;
                    card.innerHTML = `<i class="far fa-file"></i> <span class="page-badge">${i+1}</span>`;
                    card.onclick = () => this.load(i);
                    div.appendChild(card);
                });
            }
        },

        /* --- CURTAIN / SPOTLIGHT --- */
        toggleCurtain() {
            const c = document.getElementById('curtain');
            c.style.display = c.style.display==='block' ? 'none' : 'block';
            let down = false;
            c.onmousedown = () => down=true;
            window.onmouseup = () => down=false;
            window.onmousemove = e => { if(down) c.style.height = e.clientY + 'px'; }
        },
        toggleSpotlight() {
            const s = document.getElementById('spotlight');
            s.style.display = s.style.display==='block' ? 'none' : 'block';
            const hole = s.querySelector('.spotlight-hole');
            let down=false, offX, offY;
            hole.onmousedown = e => { down=true; offX=e.clientX-hole.offsetLeft; offY=e.clientY-hole.offsetTop; }
            window.onmouseup = () => down=false;
            window.onmousemove = e => { if(down) { hole.style.left = (e.clientX-offX)+'px'; hole.style.top = (e.clientY-offY)+'px'; } }
        },

        /* --- DRAG & TRASH --- */
        bindEvents() {
            // Drag Drop Image
            const s = document.getElementById('stage');
            s.ondragover = e => e.preventDefault();
            s.ondrop = e => {
                e.preventDefault();
                const f = e.dataTransfer.files[0];
                if(f && f.type.startsWith('image')) {
                    const r = new FileReader();
                    r.onload = res => {
                        fabric.Image.fromURL(res.target.result, img => {
                            img.scaleToWidth(300);
                            img.set({left:e.clientX-260, top:e.clientY});
                            app.canvas.add(img); app.history.save();
                        });
                    };
                    r.readAsDataURL(f);
                }
            };

            // Trash Logic
            const trash = document.getElementById('trash');
            app.canvas.on('object:moving', e => {
                const p = app.canvas.getPointer(e.e);
                const w = app.canvas.getWidth(), h = app.canvas.getHeight();
                if(p.x > w-100 && p.y > h-100) trash.classList.add('active');
                else trash.classList.remove('active');
            });
            app.canvas.on('mouse:up', e => {
                if(trash.classList.contains('active')) {
                    app.canvas.remove(app.canvas.getActiveObject());
                    trash.classList.remove('active');
                    app.history.save();
                }
            });

            // Save on change
            app.canvas.on('object:added', ()=>app.history.save());
            app.canvas.on('object:modified', ()=>app.history.save());
        },

        io: {
            export() {
                const blob = new Blob([JSON.stringify(app.pages)], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='board.json'; a.click();
            },
            import() {
                const i = document.getElementById('file-input');
                i.onchange = e => {
                    const r = new FileReader();
                    r.onload = res => { app.pages = JSON.parse(res.target.result); app.pages.load(0); };
                    r.readAsText(e.target.files[0]);
                };
                i.click();
            }
        }
    };

    /* =========================================
       4. GADGET SYSTEM
       ========================================= */
    const gadgets = {
        layer: document.getElementById('gadget-layer'),
        add(type) {
            const el = document.createElement('div');
            el.className = 'gadget';
            el.style.left = '300px'; el.style.top = '200px';
            
            if(type === 'ruler') {
                el.className += ' ruler';
                el.innerHTML = '<div class="ruler-ticks"></div>';
            }
            if(type === 'protractor') el.className += ' protractor';
            if(type === 'sticky') {
                el.className += ' sticky-note';
                el.innerHTML = '<textarea placeholder="Type here..."></textarea>';
            }
            if(type === 'dice') {
                el.innerHTML = `
                    <div class="dice-box">
                        <div class="dice">
                            <div class="face">1</div><div class="face">6</div>
                            <div class="face">3</div><div class="face">4</div>
                            <div class="face">5</div><div class="face">2</div>
                        </div>
                    </div>`;
                el.onclick = e => {
                    const d = el.querySelector('.dice');
                    const rx = Math.floor(Math.random()*4)*90;
                    const ry = Math.floor(Math.random()*4)*90;
                    d.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
                };
            }
            if(type === 'clock') {
                el.className += ' panel-gadget';
                el.innerHTML = `<h2 id="clock-display">00:00</h2><button onclick="gadgets.toggleTimer(this)">Start Timer</button>`;
                this.startClock(el);
            }
            if(type === 'calc') {
                el.className += ' panel-gadget';
                el.innerHTML = `<input style="width:100%; margin-bottom:5px;" id="calc-out"><br>
                ${[7,8,9,'+',4,5,6,'-',1,2,3,'*','C',0,'=','/'].map(k=>`<button onclick="gadgets.calc('${k}', this)">${k}</button>`).join('')}`;
            }

            // Close Button
            const close = document.createElement('div');
            close.innerHTML = '&times;';
            close.style.cssText = 'position:absolute; top:-10px; right:-10px; background:red; color:white; width:20px; height:20px; border-radius:50%; text-align:center; cursor:pointer; line-height:18px; font-weight:bold;';
            close.onclick = e => { e.stopPropagation(); el.remove(); };
            el.appendChild(close);

            this.layer.appendChild(el);
            this.makeDraggable(el);
        },
        makeDraggable(el) {
            let down=false, startX, startY, l, t, rot=0;
            el.addEventListener('mousedown', e => {
                if(e.target.tagName==='BUTTON' || e.target.tagName==='TEXTAREA') return;
                // Right click to rotate
                if(e.button === 2) {
                    e.preventDefault();
                    rot += 45; el.style.transform = `rotate(${rot}deg)`;
                    return;
                }
                down=true; startX=e.clientX; startY=e.clientY;
                l=el.offsetLeft; t=el.offsetTop;
            });
            window.addEventListener('mousemove', e => {
                if(down) { el.style.left = (l + e.clientX - startX)+'px'; el.style.top = (t + e.clientY - startY)+'px'; }
            });
            window.addEventListener('mouseup', () => down=false);
            el.oncontextmenu = e => e.preventDefault(); // allow right click rotate
        },
        startClock(el) {
            setInterval(() => {
                if(!el.dataset.timer) {
                    const d = new Date();
                    el.querySelector('h2').innerText = d.toLocaleTimeString([], {hour12:false});
                }
            }, 1000);
        },
        toggleTimer(btn) {
            const p = btn.parentElement;
            if(p.dataset.timer) {
                clearInterval(parseInt(p.dataset.timer));
                delete p.dataset.timer;
                btn.innerText = "Start Timer";
            } else {
                let s = 0;
                p.dataset.timer = setInterval(() => {
                    s++;
                    const m = Math.floor(s/60).toString().padStart(2,'0');
                    const sec = (s%60).toString().padStart(2,'0');
                    p.querySelector('h2').innerText = `${m}:${sec}`;
                }, 1000);
                btn.innerText = "Stop";
            }
        },
        calc(k, btn) {
            const inp = btn.parentElement.querySelector('input');
            if(k === 'C') inp.value = '';
            else if(k === '=') { try { inp.value = eval(inp.value); } catch { inp.value = 'Err'; } }
            else inp.value += k;
        }
    };

    window.onload = app.init.bind(app);
    </script>
</body>
</html>
