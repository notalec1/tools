<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenFlipchart Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE THEME & LAYOUT
           ========================================= */
        :root {
            --bg-dark: #2d3436;
            --bg-panel: #ecf0f1;
            --bg-canvas: #95a5a6;
            --accent: #e67e22; /* Promethean Orange */
            --header-height: 50px;
            --sidebar-width: 220px;
            --z-canvas: 1;
            --z-overlay: 100;
            --z-ui: 200;
            --z-modal: 1000;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        header {
            height: var(--header-height);
            background: #34495e; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #2c3e50; z-index: var(--z-ui);
        }
        .brand { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .toolbar-top button {
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer;
            margin-left: 5px; font-size: 0.9rem;
        }
        .toolbar-top button:hover { background: rgba(255,255,255,0.1); }

        /* MAIN LAYOUT */
        #app-container {
            display: flex; flex: 1; position: relative;
            height: calc(100% - var(--header-height));
        }

        /* SIDEBAR */
        #sidebar {
            width: var(--sidebar-width); background: var(--bg-panel);
            border-right: 1px solid #bdc3c7;
            display: flex; flex-direction: column; padding: 10px; overflow-y: auto;
            z-index: var(--z-ui);
        }
        .page-thumbnail {
            width: 100%; height: 120px; background: white;
            border: 3px solid transparent; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;
            position: relative; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: #ddd;
        }
        .page-thumbnail.active { border-color: var(--accent); }
        .page-num {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;
        }

        /* CANVAS AREA */
        #canvas-stage {
            flex: 1; background-color: var(--bg-canvas);
            position: relative; overflow: hidden;
        }

        /* FLOATING TOOLBAR */
        #main-toolbar {
            position: absolute; top: 20px; right: 20px;
            width: 54px; background: white;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 10px 0; display: flex; flex-direction: column; align-items: center; gap: 6px;
            z-index: var(--z-ui);
        }
        .tool-btn {
            width: 40px; height: 40px; border: none; background: transparent;
            border-radius: 6px; cursor: pointer; color: #2c3e50; font-size: 1.1rem;
        }
        .tool-btn:hover { background: #dfe6e9; }
        .tool-btn.active { background: #ffeaa7; color: #d35400; border: 2px solid var(--accent); }
        .sep { width: 30px; height: 1px; background: #eee; margin: 4px 0; }

        /* PROPERTIES BAR (COLORS) */
        #properties-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 20px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            z-index: var(--z-ui);
        }
        .prop-row { display: flex; align-items: center; gap: 10px; }
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
        .color-swatch {
            width: 22px; height: 22px; border-radius: 3px; cursor: pointer;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .color-swatch.active { transform: scale(1.2); border: 2px solid #333; z-index: 2; }
        
        input[type=range] { width: 120px; }

        /* =========================================
           2. OVERLAYS & MATH TOOLS
           ========================================= */
        #overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through to canvas unless hitting a tool */
            z-index: var(--z-overlay); overflow: hidden;
        }

        .floating-tool {
            position: absolute; pointer-events: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: grab; user-select: none;
        }
        .floating-tool:active { cursor: grabbing; }

        /* Ruler */
        .tool-ruler {
            width: 500px; height: 70px;
            background: rgba(255, 255, 230, 0.9);
            border: 1px solid #bbb; border-radius: 4px;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .ruler-ticks {
            height: 30px; width: 100%;
            background-image: repeating-linear-gradient(90deg, #333 0, #333 1px, transparent 1px, transparent 10px);
            border-top: 1px solid #333;
        }

        /* Protractor */
        .tool-protractor {
            width: 300px; height: 150px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #333;
            border-radius: 150px 150px 0 0; /* Semi-circle */
            display: flex; justify-content: center; align-items: flex-end;
        }
        .tool-protractor::after {
            content: ''; width: 10px; height: 10px; background: black; border-radius: 50%; margin-bottom: 5px;
        }

        /* Clock */
        .tool-clock {
            width: 200px; padding: 10px; background: #333; color: #0f0;
            border: 4px solid #555; border-radius: 10px;
            font-family: 'Courier New', monospace; text-align: center;
        }
        .clock-display { font-size: 2.5rem; margin: 10px 0; background: #000; border-radius: 4px;}
        .clock-controls button {
            background: #555; color: white; border: none; padding: 5px 10px; cursor: pointer;
        }

        /* Curtain / Spotlight */
        #curtain-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: var(--z-overlay);
            display: none; pointer-events: auto;
        }
        .curtain-handle {
            position: absolute; background: var(--accent);
            display: flex; align-items: center; justify-content: center; color: white;
            cursor: pointer;
        }

        #spotlight-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; pointer-events: auto; overflow: hidden;
            z-index: var(--z-overlay);
            background: transparent;
        }
        .spotlight-mask {
            position: absolute; width: 200px; height: 200px;
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.9); /* The dark area */
            cursor: move;
            border: 2px solid rgba(255,255,255,0.5);
        }

    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="brand"><i class="fas fa-chalkboard"></i> &nbsp; OpenFlipchart Pro</div>
        <div class="toolbar-top">
            <button onclick="app.toggleTool('ruler')"><i class="fas fa-ruler-horizontal"></i> Ruler</button>
            <button onclick="app.toggleTool('protractor')"><i class="fas fa-ruler-combined"></i> Protractor</button>
            <button onclick="app.toggleTool('triangle')"><i class="fas fa-play" style="transform: rotate(-90deg);"></i> Set Sq</button>
            <span style="border-left:1px solid #555; margin:0 5px;"></span>
            <button onclick="app.toggleTool('clock')"><i class="fas fa-clock"></i> Clock</button>
            <button onclick="app.toggleCurtain()"><i class="fas fa-theater-masks"></i> Reveal</button>
            <button onclick="app.toggleSpotlight()"><i class="fas fa-lightbulb"></i> Spotlight</button>
            <span style="border-left:1px solid #555; margin:0 5px;"></span>
            <button id="btn-import">Import</button>
            <button id="btn-export">Save</button>
            <input type="file" id="file-input" hidden accept=".json">
        </div>
    </header>

    <div id="app-container">
        
        <!-- Sidebar -->
        <div id="sidebar">
            <button style="width:100%; padding:8px; background:var(--accent); color:white; border:none; cursor:pointer;" id="add-page-btn">
                <i class="fas fa-plus"></i> New Page
            </button>
            <div id="page-list" style="margin-top:10px;"></div>
        </div>

        <!-- Canvas Stage -->
        <div id="canvas-stage">
            <canvas id="c"></canvas>
            
            <!-- OVERLAY LAYER (Tools live here) -->
            <div id="overlay-layer">
                <!-- Tools injected by JS -->
            </div>

            <!-- Full Screen Overlays -->
            <div id="curtain-overlay">
                <div class="curtain-handle" style="bottom: 20px; right: 20px; padding: 10px;">
                    <i class="fas fa-arrows-alt"></i> Drag to Resize
                </div>
            </div>
            <div id="spotlight-overlay">
                <div class="spotlight-mask" style="top:30%; left:40%;"></div>
            </div>
        </div>

        <!-- Floating Toolbar (Drawing) -->
        <div id="main-toolbar">
            <button class="tool-btn active" id="tool-select" title="Select (V)"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="tool-pen" title="Pen (P)"><i class="fas fa-pen"></i></button>
            <button class="tool-btn" id="tool-highlighter" title="Highlighter"><i class="fas fa-highlighter"></i></button>
            <button class="tool-btn" id="tool-eraser" title="Eraser"><i class="fas fa-eraser"></i></button>
            <div class="sep"></div>
            <button class="tool-btn" id="tool-rect" title="Rectangle"><i class="far fa-square"></i></button>
            <button class="tool-btn" id="tool-circle" title="Circle"><i class="far fa-circle"></i></button>
            <button class="tool-btn" id="tool-text" title="Text"><i class="fas fa-font"></i></button>
            <div class="sep"></div>
            <button class="tool-btn" id="tool-undo" title="Undo"><i class="fas fa-undo"></i></button>
            <button class="tool-btn" id="tool-redo" title="Redo"><i class="fas fa-redo"></i></button>
            <button class="tool-btn" id="tool-clear" title="Clear"><i class="fas fa-trash-alt"></i></button>
        </div>

        <!-- Properties Bar -->
        <div id="properties-bar">
            <!-- Row 1: Brights -->
            <div class="color-grid">
                <div class="color-swatch active" style="background:#000000" data-color="#000000"></div>
                <div class="color-swatch" style="background:#7f8c8d" data-color="#7f8c8d"></div>
                <div class="color-swatch" style="background:#c0392b" data-color="#c0392b"></div>
                <div class="color-swatch" style="background:#e67e22" data-color="#e67e22"></div>
                <div class="color-swatch" style="background:#f1c40f" data-color="#f1c40f"></div>
                <div class="color-swatch" style="background:#27ae60" data-color="#27ae60"></div>
                <div class="color-swatch" style="background:#2980b9" data-color="#2980b9"></div>
                <div class="color-swatch" style="background:#8e44ad" data-color="#8e44ad"></div>
            </div>
            <!-- Row 2: Pastels/Darks -->
            <div class="color-grid">
                <div class="color-swatch" style="background:#ffffff" data-color="#ffffff"></div>
                <div class="color-swatch" style="background:#bdc3c7" data-color="#bdc3c7"></div>
                <div class="color-swatch" style="background:#e74c3c" data-color="#e74c3c"></div>
                <div class="color-swatch" style="background:#d35400" data-color="#d35400"></div>
                <div class="color-swatch" style="background:#f39c12" data-color="#f39c12"></div>
                <div class="color-swatch" style="background:#2ecc71" data-color="#2ecc71"></div>
                <div class="color-swatch" style="background:#3498db" data-color="#3498db"></div>
                <div class="color-swatch" style="background:#9b59b6" data-color="#9b59b6"></div>
            </div>

            <div class="prop-row" style="margin-top: 5px; width: 100%; justify-content: space-between;">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-circle" style="font-size:0.5rem; color:#aaa; margin-right:5px;"></i>
                    <input type="range" id="size-slider" min="1" max="50" value="3">
                    <i class="fas fa-circle" style="font-size:1.2rem; color:#aaa; margin-left:5px;"></i>
                </div>
                <select id="bg-select" style="padding:4px; border-radius:4px;">
                    <option value="white">White</option>
                    <option value="grid">Grid</option>
                    <option value="lines">Lined</option>
                    <option value="blue">Blue</option>
                    <option value="black">Black</option>
                </select>
            </div>
        </div>
    </div>

    <!-- =========================================
         3. JAVASCRIPT LOGIC
         ========================================= -->
    <script>
    class WhiteboardApp {
        constructor() {
            this.canvas = null;
            this.pages = []; 
            this.currentPageIndex = 0;
            this.undoStack = []; this.redoStack = [];
            this.historyProcessing = false;
            
            // State
            this.currentMode = 'select'; 
            this.currentColor = '#000000';
            this.currentSize = 3;

            // Overlay State
            this.activeTools = {}; // ruler, clock, etc.
            
            this.init();
        }

        init() {
            // Fabric Setup
            this.canvas = new fabric.Canvas('c', {
                isDrawingMode: false, backgroundColor: '#ffffff', selection: true
            });

            this.setupResponsiveCanvas();
            this.bindEvents();
            this.addNewPage();
            this.setTool('pen');
            
            // Init Spotlight Logic
            this.initSpotlight();
        }

        /* --- Canvas & History --- */
        
        saveState() {
            if(this.historyProcessing) return;
            if (this.undoStack.length > 50) this.undoStack.shift();
            this.undoStack.push(JSON.stringify(this.canvas.toJSON()));
            this.redoStack = [];
        }

        undo() {
            if (this.undoStack.length === 0) return;
            this.historyProcessing = true;
            this.redoStack.push(JSON.stringify(this.canvas.toJSON()));
            const state = this.undoStack.pop();
            this.canvas.loadFromJSON(state, () => {
                this.canvas.renderAll();
                this.historyProcessing = false;
                this.updateBrushSettings();
            });
        }

        redo() {
            if (this.redoStack.length === 0) return;
            this.historyProcessing = true;
            this.undoStack.push(JSON.stringify(this.canvas.toJSON()));
            const state = this.redoStack.pop();
            this.canvas.loadFromJSON(state, () => {
                this.canvas.renderAll();
                this.historyProcessing = false;
                this.updateBrushSettings();
            });
        }

        setupResponsiveCanvas() {
            const stage = document.getElementById('canvas-stage');
            new ResizeObserver(() => {
                this.canvas.setWidth(stage.clientWidth);
                this.canvas.setHeight(stage.clientHeight);
                this.canvas.renderAll();
                this.updateBackground();
            }).observe(stage);
        }

        /* --- Tools & Modes --- */
        
        setTool(mode) {
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`tool-${mode}`);
            if(btn) btn.classList.add('active');

            this.currentMode = mode;
            this.canvas.isDrawingMode = false;
            this.canvas.selection = true;
            this.canvas.off('mouse:down');

            if (mode === 'pen' || mode === 'highlighter') {
                this.canvas.isDrawingMode = true;
                this.canvas.selection = false;
                this.updateBrushSettings();
            } 
            else if (mode === 'eraser') {
                this.canvas.isDrawingMode = true;
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                this.canvas.freeDrawingBrush.color = '#ffffff'; 
                this.canvas.freeDrawingBrush.width = 40;
            }
            else if (['rect','circle'].includes(mode)) {
                this.canvas.selection = false;
                this.canvas.defaultCursor = 'crosshair';
                this.setupShapeDrawer(mode);
            }
        }

        updateBrushSettings() {
            if (!this.canvas.freeDrawingBrush) return;
            
            const baseSize = parseInt(this.currentSize, 10);
            
            if (this.currentMode === 'pen') {
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                this.canvas.freeDrawingBrush.color = this.currentColor;
                this.canvas.freeDrawingBrush.width = baseSize;
                this.canvas.freeDrawingBrush.decimate = 2.5; 
            } 
            else if (this.currentMode === 'highlighter') {
                this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                const c = new fabric.Color(this.currentColor);
                this.canvas.freeDrawingBrush.color = c.setAlpha(0.3).toRgba();
                this.canvas.freeDrawingBrush.width = baseSize * 4;
                this.canvas.freeDrawingBrush.decimate = 2.5;
            }
        }

        setupShapeDrawer(type) {
            let rect, isDown, origX, origY;
            this.canvas.on('mouse:down', (o) => {
                isDown = true;
                const p = this.canvas.getPointer(o.e);
                origX = p.x; origY = p.y;
                
                if (type === 'rect') {
                    rect = new fabric.Rect({ left: origX, top: origY, width:0, height:0, fill: this.currentColor });
                } else {
                    rect = new fabric.Circle({ left: origX, top: origY, radius:1, fill: this.currentColor });
                }
                this.canvas.add(rect);
            });
            this.canvas.on('mouse:move', (o) => {
                if(!isDown) return;
                const p = this.canvas.getPointer(o.e);
                if(type === 'rect') {
                    rect.set({ width: Math.abs(origX - p.x), height: Math.abs(origY - p.y) });
                    if(origX > p.x) rect.set({ left: p.x });
                    if(origY > p.y) rect.set({ top: p.y });
                } else {
                    rect.set({ radius: Math.abs(origX - p.x)/2 });
                    if(origX > p.x) rect.set({ left: p.x });
                }
                this.canvas.renderAll();
            });
            this.canvas.on('mouse:up', () => {
                isDown = false; rect.setCoords();
                this.saveState(); this.setTool('select');
            });
        }

        /* --- Overlays & Math Tools --- */

        toggleTool(toolType) {
            const layer = document.getElementById('overlay-layer');
            
            // If exists, remove it
            if (this.activeTools[toolType]) {
                layer.removeChild(this.activeTools[toolType]);
                delete this.activeTools[toolType];
                return;
            }

            // Create New
            const el = document.createElement('div');
            el.className = `floating-tool tool-${toolType}`;
            el.style.left = '100px'; el.style.top = '100px';

            if (toolType === 'ruler') {
                el.innerHTML = `<div class="ruler-ticks"></div>`;
            } 
            else if (toolType === 'protractor') {
                el.innerHTML = `<div style="text-align:center; margin-bottom:5px; font-weight:bold;">180Â°</div>`;
            }
            else if (toolType === 'triangle') {
                el.style.width = '0'; el.style.height = '0'; el.style.background = 'transparent'; el.style.boxShadow = 'none';
                el.style.borderLeft = '150px solid transparent';
                el.style.borderRight = '0 solid transparent';
                el.style.borderBottom = '250px solid rgba(255,255,255,0.8)';
            }
            else if (toolType === 'clock') {
                el.innerHTML = `
                    <div style="font-size:0.8rem; color:#aaa;">STOPWATCH</div>
                    <div class="clock-display">00:00</div>
                    <div class="clock-controls">
                        <button class="btn-start">Start</button>
                        <button class="btn-reset">Reset</button>
                        <button class="btn-close" style="color:red; float:right;">X</button>
                    </div>
                `;
                this.setupClockLogic(el);
            }

            layer.appendChild(el);
            this.makeDraggable(el);
            this.activeTools[toolType] = el;
        }

        setupClockLogic(el) {
            let seconds = 0, interval = null;
            const display = el.querySelector('.clock-display');
            const format = (s) => {
                const min = Math.floor(s / 60).toString().padStart(2,'0');
                const sec = (s % 60).toString().padStart(2,'0');
                return `${min}:${sec}`;
            }

            el.querySelector('.btn-start').onclick = (e) => {
                e.stopPropagation(); // prevent drag
                if (interval) {
                    clearInterval(interval); interval = null;
                    e.target.innerText = "Start";
                } else {
                    interval = setInterval(() => { seconds++; display.innerText = format(seconds); }, 1000);
                    e.target.innerText = "Stop";
                }
            };
            el.querySelector('.btn-reset').onclick = (e) => {
                e.stopPropagation();
                clearInterval(interval); interval = null; seconds = 0;
                display.innerText = "00:00";
                el.querySelector('.btn-start').innerText = "Start";
            };
            el.querySelector('.btn-close').onclick = (e) => {
                e.stopPropagation();
                if(interval) clearInterval(interval);
                el.remove();
                delete this.activeTools['clock'];
            }
        }

        makeDraggable(el) {
            let isDragging = false, isRotating = false;
            let startX, startY, initialLeft, initialTop, startAngle = 0, currentRotation = 0;

            el.addEventListener('mousedown', (e) => {
                // If right click or wheel click, rotate
                if (e.button === 1 || e.button === 2) {
                    isRotating = true; e.preventDefault();
                    startAngle = e.clientY; // simple Y-axis drag to rotate
                    return;
                }
                if (e.target.tagName === 'BUTTON') return; // Don't drag if clicking a button
                
                isDragging = true;
                startX = e.clientX; startY = e.clientY;
                initialLeft = el.offsetLeft; initialTop = el.offsetTop;
            });

            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    el.style.left = `${initialLeft + dx}px`;
                    el.style.top = `${initialTop + dy}px`;
                }
                if (isRotating) {
                    const dy = e.clientY - startAngle;
                    el.style.transform = `rotate(${currentRotation + dy}deg)`;
                }
            });

            window.addEventListener('mouseup', (e) => {
                if (isRotating) {
                    const dy = e.clientY - startAngle;
                    currentRotation += dy;
                }
                isDragging = false; isRotating = false;
            });

            // Prevent context menu on tools to allow right-click rotate
            el.addEventListener('contextmenu', e => e.preventDefault());
            
            // Wheel rotate
            el.addEventListener('wheel', (e) => {
                e.preventDefault();
                currentRotation += (e.deltaY > 0 ? 5 : -5);
                el.style.transform = `rotate(${currentRotation}deg)`;
            });
        }

        /* --- Curtain & Spotlight --- */

        toggleCurtain() {
            const c = document.getElementById('curtain-overlay');
            c.style.display = (c.style.display === 'block') ? 'none' : 'block';
            if (c.style.display === 'block') {
                // Basic curtain drag logic (height only for simplicity)
                const handle = c.querySelector('.curtain-handle');
                let dragging = false;
                handle.onmousedown = () => dragging = true;
                window.onmouseup = () => dragging = false;
                window.onmousemove = (e) => {
                    if(dragging) {
                        c.style.height = e.clientY + 'px';
                    }
                }
            }
        }

        toggleSpotlight() {
            const s = document.getElementById('spotlight-overlay');
            s.style.display = (s.style.display === 'block') ? 'none' : 'block';
        }

        initSpotlight() {
            const mask = document.querySelector('.spotlight-mask');
            let dragging = false, offX, offY;
            
            mask.addEventListener('mousedown', (e) => {
                dragging = true;
                offX = e.clientX - mask.offsetLeft;
                offY = e.clientY - mask.offsetTop;
            });
            window.addEventListener('mouseup', () => dragging = false);
            window.addEventListener('mousemove', (e) => {
                if(dragging) {
                    mask.style.left = (e.clientX - offX) + 'px';
                    mask.style.top = (e.clientY - offY) + 'px';
                }
            });
        }

        /* --- Page & I/O --- */
        
        addNewPage() {
            if (this.pages.length > 0) this.pages[this.currentPageIndex] = this.canvas.toJSON();
            this.pages.push({ version: "5.3.0", objects: [], background: "#ffffff" });
            this.renderPageList();
            this.loadPage(this.pages.length - 1);
        }

        loadPage(idx) {
            this.pages[this.currentPageIndex] = this.canvas.toJSON(); // save old
            this.currentPageIndex = idx;
            this.canvas.loadFromJSON(this.pages[idx], () => {
                this.canvas.renderAll();
                this.updateUIForPage();
                this.undoStack = []; this.redoStack = []; // reset history for page
                this.setTool(this.currentMode); // restore tool
            });
        }

        renderPageList() {
            const list = document.getElementById('page-list');
            list.innerHTML = '';
            this.pages.forEach((p, i) => {
                const el = document.createElement('div');
                el.className = `page-thumbnail ${i===this.currentPageIndex?'active':''}`;
                el.innerHTML = `<span class="page-num">${i+1}</span><i class="far fa-file"></i>`;
                el.onclick = () => this.loadPage(i);
                list.appendChild(el);
            });
        }

        updateUIForPage() {
            document.querySelectorAll('.page-thumbnail').forEach((el,i) => {
                if(i===this.currentPageIndex) el.classList.add('active');
                else el.classList.remove('active');
            });
            this.updateBackground();
        }

        updateBackground() {
            const val = document.getElementById('bg-select').value;
            this.canvas.setBackgroundColor('#ffffff', this.canvas.renderAll.bind(this.canvas));
            
            if (val === 'black') this.canvas.setBackgroundColor('#000000', this.canvas.renderAll.bind(this.canvas));
            else if (val === 'blue') this.canvas.setBackgroundColor('#81ecec', this.canvas.renderAll.bind(this.canvas));
            else if (val === 'grid') {
                const pat = document.createElement('canvas');
                pat.width = 40; pat.height = 40;
                const ctx = pat.getContext('2d');
                ctx.strokeStyle = '#eee'; ctx.beginPath();
                ctx.moveTo(0,0); ctx.lineTo(40,0); ctx.moveTo(0,0); ctx.lineTo(0,40); ctx.stroke();
                this.canvas.setBackgroundColor(new fabric.Pattern({source:pat, repeat:'repeat'}), this.canvas.renderAll.bind(this.canvas));
            }
        }

        bindEvents() {
            // Main Tools
            ['select','pen','highlighter','eraser','rect','circle'].forEach(t => {
                document.getElementById(`tool-${t}`).onclick = () => this.setTool(t);
            });
            
            document.getElementById('tool-text').onclick = () => {
                const t = new fabric.IText('Text', { left:200, top:200, fill:this.currentColor, fontSize:40 });
                this.canvas.add(t); this.canvas.setActiveObject(t); this.setTool('select');
            };

            // Undo/Redo/Clear
            document.getElementById('tool-undo').onclick = () => this.undo();
            document.getElementById('tool-redo').onclick = () => this.redo();
            document.getElementById('tool-clear').onclick = () => {
                if(confirm('Clear Page?')) { this.canvas.clear(); this.updateBackground(); this.saveState(); }
            };

            // Colors
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.onclick = (e) => {
                    document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('active'));
                    e.target.classList.add('active');
                    this.currentColor = e.target.getAttribute('data-color');
                    
                    const active = this.canvas.getActiveObject();
                    if(active) {
                        active.set({fill:this.currentColor});
                        if(active.type==='path') active.set({stroke:this.currentColor});
                        this.canvas.renderAll(); this.saveState();
                    }
                    // Keep Pen Active
                    if(this.currentMode==='pen' || this.currentMode==='highlighter') {
                        this.updateBrushSettings();
                    }
                }
            });

            // Sliders & Selects
            document.getElementById('size-slider').oninput = (e) => {
                this.currentSize = e.target.value; this.updateBrushSettings();
            };
            document.getElementById('bg-select').onchange = () => this.updateBackground();
            document.getElementById('add-page-btn').onclick = () => this.addNewPage();

            // Shortcuts
            document.addEventListener('keydown', (e) => {
                if((e.ctrlKey||e.metaKey)&&e.key==='z') { e.preventDefault(); this.undo(); }
                if((e.ctrlKey||e.metaKey)&&e.key==='y') { e.preventDefault(); this.redo(); }
                if(e.key==='Delete') {
                    const active = this.canvas.getActiveObjects();
                    if(active.length) {
                        this.canvas.discardActiveObject();
                        active.forEach(o => this.canvas.remove(o));
                        this.saveState();
                    }
                }
            });
            
            // I/O
            document.getElementById('btn-export').onclick = () => {
                this.pages[this.currentPageIndex] = this.canvas.toJSON();
                const blob = new Blob([JSON.stringify({pages:this.pages})], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download='lesson.json'; a.click();
            };
            const fi = document.getElementById('file-input');
            document.getElementById('btn-import').onclick = () => fi.click();
            fi.onchange = (e) => {
                const r = new FileReader();
                r.onload = (res) => {
                    try {
                        const d = JSON.parse(res.target.result);
                        if(d.pages) {
                            this.pages = d.pages; this.currentPageIndex=0;
                            this.renderPageList(); this.loadPage(0);
                        }
                    } catch(err) { alert('Load Error'); }
                };
                if(e.target.files[0]) r.readAsText(e.target.files[0]);
                e.target.value='';
            };

            // Fabric Events for History
            this.canvas.on('object:added', () => this.saveState());
            this.canvas.on('object:modified', () => this.saveState());
            this.canvas.on('object:removed', () => this.saveState());
        }
    }

    window.onload = () => window.app = new WhiteboardApp();
    </script>
</body>
</html>
