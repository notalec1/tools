<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenFlipchart Studio v4</title>
    
    <!-- Fabric.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CSS VARIABLES & THEME
           ========================================= */
        :root {
            --bg-dark: #2c3e50;
            --bg-light: #ecf0f1;
            --accent-design: #e67e22; /* Orange for Editing */
            --accent-present: #2980b9; /* Blue for Presenting */
            --toolbar-bg: #ffffff;
            --text-color: #2c3e50;
            --header-height: 55px;
            --sidebar-width: 260px;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            overflow: hidden;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
        }

        /* Mode Indicator Border */
        body.mode-design { border: 4px solid var(--accent-design); }
        body.mode-present { border: 4px solid var(--accent-present); }

        /* HEADER */
        header {
            height: var(--header-height);
            background: #34495e; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 500;
        }
        .mode-switch {
            background: rgba(0,0,0,0.3); padding: 4px; border-radius: 20px;
            display: flex; gap: 5px;
        }
        .mode-btn {
            padding: 6px 12px; border-radius: 16px; border: none; cursor: pointer;
            font-size: 0.85rem; font-weight: bold; color: #ccc; background: transparent;
        }
        .mode-btn.active { color: white; background: rgba(255,255,255,0.2); }
        body.mode-design .mode-btn.design-btn { color: var(--accent-design); background: white; }
        body.mode-present .mode-btn.present-btn { color: var(--accent-present); background: white; }

        /* APP LAYOUT */
        #app-container {
            display: flex; flex: 1; height: calc(100% - var(--header-height));
            position: relative;
        }

        /* SIDEBAR (Browser) */
        #sidebar {
            width: var(--sidebar-width); background: var(--bg-light);
            border-right: 1px solid #bdc3c7; display: flex; flex-direction: column;
            z-index: 400; transition: transform 0.3s;
        }
        .sidebar-tabs {
            display: flex; border-bottom: 1px solid #ccc; background: #e0e0e0;
        }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            cursor: pointer; font-weight: bold; color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            background: var(--bg-light); color: var(--text-color);
            border-bottom-color: var(--accent-design);
        }
        .sidebar-content {
            flex: 1; overflow-y: auto; padding: 10px; display: none;
        }
        .sidebar-content.active { display: block; }

        /* Page Thumbnails */
        .page-thumb {
            height: 140px; background: white; border: 3px solid #ccc;
            margin-bottom: 15px; position: relative; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .page-thumb.active { border-color: var(--accent-design); }
        .page-badge {
            position: absolute; bottom: 5px; right: 5px;
            background: #555; color: white; padding: 2px 6px;
            font-size: 0.8rem; border-radius: 4px;
        }

        /* Library Items */
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .lib-item {
            height: 60px; background: white; border: 1px solid #ccc;
            display: flex; align-items: center; justify-content: center;
            cursor: grab; font-size: 1.5rem; color: #333;
            transition: transform 0.1s;
        }
        .lib-item:hover { transform: scale(1.05); border-color: #999; }
        .lib-item:active { cursor: grabbing; }

        /* CANVAS */
        #canvas-wrapper {
            flex: 1; position: relative; background: #95a5a6;
            overflow: hidden; touch-action: none;
        }
        /* Trash Zone */
        #trash-can {
            position: absolute; bottom: 20px; right: 20px;
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(192, 57, 43, 0.8); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 300; transition: transform 0.2s;
            pointer-events: none; /* Logic handled via canvas events */
            opacity: 0.6;
        }
        #trash-can.hover { transform: scale(1.2); opacity: 1; background: #e74c3c; }

        /* FLOATING TOOLBAR */
        #main-toolbar {
            position: absolute; top: 20px; right: 20px;
            width: 60px; background: white; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            display: flex; flex-direction: column; align-items: center;
            padding: 10px 0; gap: 5px; z-index: 300;
        }
        .tool-btn {
            width: 44px; height: 44px; border: none; background: transparent;
            border-radius: 6px; font-size: 1.2rem; color: #333; cursor: pointer;
        }
        .tool-btn:hover { background: #eee; }
        .tool-btn.active { background: #ffeaa7; color: #d35400; border: 2px solid var(--accent-design); }
        .sep { width: 40px; height: 1px; background: #ddd; margin: 5px 0; }

        /* PROPERTIES BAR */
        #properties-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            display: flex; align-items: center; gap: 12px; z-index: 300;
        }
        .color-dot {
            width: 26px; height: 26px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.active { transform: scale(1.2); border-color: #333; }

        /* CONTEXT MENU (Right Click) */
        #context-menu {
            position: absolute; background: white; width: 180px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 4px;
            display: none; flex-direction: column; z-index: 1000;
            padding: 5px 0; font-size: 0.9rem;
        }
        .ctx-item {
            padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            color: #333;
        }
        .ctx-item:hover { background: #f1f2f6; }
        .ctx-item i { width: 20px; text-align: center; color: #7f8c8d; }
        .ctx-sep { height: 1px; background: #eee; margin: 4px 0; }

    </style>
</head>
<body class="mode-design">

    <!-- Header -->
    <header>
        <div style="font-weight:bold; font-size:1.2rem;">
            <i class="fas fa-chalkboard"></i> OpenFlipchart <span style="font-weight:normal; font-size:0.8rem; opacity:0.7;">v4.0 Pro</span>
        </div>
        
        <!-- Mode Switcher -->
        <div class="mode-switch">
            <button class="mode-btn design-btn active" onclick="app.setMode('design')">DESIGN</button>
            <button class="mode-btn present-btn" onclick="app.setMode('present')">PRESENT</button>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="app.io.import()" style="background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Open</button>
            <button onclick="app.io.export()" style="background:#2980b9; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Save</button>
        </div>
    </header>

    <div id="app-container">
        
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" onclick="app.ui.switchTab('pages')">Pages</button>
                <button class="tab-btn" onclick="app.ui.switchTab('lib')">Library</button>
            </div>
            
            <!-- Pages Tab -->
            <div id="tab-pages" class="sidebar-content active">
                <button onclick="app.pages.add()" style="width:100%; padding:10px; background:var(--accent-design); color:white; border:none; margin-bottom:10px; cursor:pointer; font-weight:bold;">+ New Page</button>
                <div id="page-list"></div>
            </div>

            <!-- Library Tab -->
            <div id="tab-lib" class="sidebar-content">
                <div style="padding:5px; color:#7f8c8d; font-size:0.8rem; margin-bottom:10px;">Drag shapes to canvas</div>
                <div class="lib-grid">
                    <div class="lib-item" draggable="true" ondragstart="app.lib.dragStart(event, 'rect')"><i class="far fa-square"></i></div>
                    <div class="lib-item" draggable="true" ondragstart="app.lib.dragStart(event, 'circle')"><i class="far fa-circle"></i></div>
                    <div class="lib-item" draggable="true" ondragstart="app.lib.dragStart(event, 'triangle')"><i class="fas fa-caret-up"></i></div>
                    <div class="lib-item" draggable="true" ondragstart="app.lib.dragStart(event, 'star')"><i class="fas fa-star"></i></div>
                    <div class="lib-item" draggable="true" ondragstart="app.lib.dragStart(event, 'arrow')"><i class="fas fa-long-arrow-alt-right"></i></div>
                    <div class="lib-item" draggable="true" ondragstart="app.lib.dragStart(event, 'line')"><i class="fas fa-minus"></i></div>
                </div>
            </div>
        </aside>

        <!-- Canvas -->
        <main id="canvas-wrapper">
            <canvas id="c"></canvas>
            <div id="trash-can"><i class="fas fa-trash"></i></div>
            
            <!-- Context Menu -->
            <div id="context-menu">
                <div class="ctx-item" onclick="app.ctx.action('lock')"><i class="fas fa-lock"></i> Lock</div>
                <div class="ctx-item" onclick="app.ctx.action('unlock')"><i class="fas fa-lock-open"></i> Unlock</div>
                <div class="ctx-sep"></div>
                <div class="ctx-item" onclick="app.ctx.action('front')"><i class="fas fa-level-up-alt"></i> Bring to Front</div>
                <div class="ctx-item" onclick="app.ctx.action('back')"><i class="fas fa-level-down-alt"></i> Send to Back</div>
                <div class="ctx-sep"></div>
                <div class="ctx-item" onclick="app.ctx.action('clone')"><i class="fas fa-clone"></i> Duplicate</div>
                <div class="ctx-item" onclick="app.ctx.action('cloner')"><i class="fas fa-stamp"></i> Toggle Infinite Cloner</div>
                <div class="ctx-sep"></div>
                <div class="ctx-item" onclick="app.ctx.action('group')"><i class="fas fa-object-group"></i> Group</div>
                <div class="ctx-item" onclick="app.ctx.action('ungroup')"><i class="fas fa-object-ungroup"></i> Ungroup</div>
            </div>
        </main>

        <!-- Toolbar -->
        <div id="main-toolbar">
            <button class="tool-btn active" id="btn-select" onclick="app.tools.set('select')"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="btn-pen" onclick="app.tools.set('pen')"><i class="fas fa-pen"></i></button>
            <button class="tool-btn" id="btn-highlighter" onclick="app.tools.set('highlighter')"><i class="fas fa-highlighter"></i></button>
            <button class="tool-btn" id="btn-eraser" onclick="app.tools.set('eraser')"><i class="fas fa-eraser"></i></button>
            <div class="sep"></div>
            <button class="tool-btn" id="btn-text" onclick="app.tools.addText()"><i class="fas fa-font"></i></button>
            <button class="tool-btn" id="btn-connector" onclick="app.tools.set('connector')" title="Connector Line"><i class="fas fa-project-diagram"></i></button>
            <div class="sep"></div>
            <button class="tool-btn" onclick="app.history.undo()"><i class="fas fa-undo"></i></button>
            <button class="tool-btn" onclick="app.history.redo()"><i class="fas fa-redo"></i></button>
        </div>

        <!-- Properties -->
        <div id="properties-bar">
            <div class="color-dot active" style="background:#000;" onclick="app.props.setColor('#000', this)"></div>
            <div class="color-dot" style="background:#e74c3c;" onclick="app.props.setColor('#e74c3c', this)"></div>
            <div class="color-dot" style="background:#2980b9;" onclick="app.props.setColor('#2980b9', this)"></div>
            <div class="color-dot" style="background:#27ae60;" onclick="app.props.setColor('#27ae60', this)"></div>
            <div class="color-dot" style="background:#f1c40f;" onclick="app.props.setColor('#f1c40f', this)"></div>
            <div style="width:1px; height:20px; background:#ccc;"></div>
            <input type="range" min="1" max="50" value="3" oninput="app.props.setSize(this.value)">
            <div style="width:1px; height:20px; background:#ccc;"></div>
            <label style="font-size:0.8rem; display:flex; align-items:center;">
                <input type="checkbox" onchange="app.props.toggleGrid(this.checked)"> Snap
            </label>
        </div>

        <input type="file" id="file-loader" hidden>
    </div>

    <!-- =========================================
         APPLICATION LOGIC
         ========================================= -->
    <script>
    /**
     * OpenFlipchart v4.0 Controller
     */
    const app = {
        canvas: null,
        mode: 'design', // 'design' or 'present'
        state: {
            color: '#000000',
            size: 3,
            tool: 'select',
            isSnapping: false,
            pages: [],
            pageIndex: 0
        },
        
        init() {
            // Fabric Config
            fabric.Object.prototype.transparentCorners = false;
            fabric.Object.prototype.cornerColor = '#2c3e50';
            fabric.Object.prototype.cornerStyle = 'circle';
            
            this.canvas = new fabric.Canvas('c', {
                backgroundColor: '#ffffff',
                selection: true,
                preserveObjectStacking: true
            });

            this.ui.resize();
            window.addEventListener('resize', () => this.ui.resize());
            
            // Events
            this.bindEvents();
            this.pages.add(); // Init first page
            this.tools.set('pen'); // Start with pen
            
            // Global click to close context menu
            window.addEventListener('click', () => {
                document.getElementById('context-menu').style.display = 'none';
            });
        },

        setMode(mode) {
            this.mode = mode;
            document.body.className = `mode-${mode}`;
            
            // UI Toggle
            document.querySelector('.design-btn').classList.toggle('active', mode === 'design');
            document.querySelector('.present-btn').classList.toggle('active', mode === 'present');

            if (mode === 'present') {
                this.canvas.selection = false;
                this.canvas.forEachObject(o => {
                    o.selectable = !o.lockMovementX; // Only unlocked items selectable
                    o.hoverCursor = o.selectable ? 'pointer' : 'default';
                });
                this.tools.set('select');
                document.getElementById('main-toolbar').style.display = 'none';
            } else {
                this.canvas.selection = true;
                this.canvas.forEachObject(o => {
                    o.selectable = true;
                    o.hoverCursor = 'move';
                });
                document.getElementById('main-toolbar').style.display = 'flex';
            }
            this.canvas.renderAll();
        },

        /* --- UI & LAYOUT --- */
        ui: {
            resize() {
                const el = document.getElementById('canvas-wrapper');
                app.canvas.setWidth(el.clientWidth);
                app.canvas.setHeight(el.clientHeight);
                app.canvas.renderAll();
            },
            switchTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.sidebar-content').forEach(c => c.classList.remove('active'));
                
                // Active Logic relies on event bubbling or index match, simplified here:
                if(tab === 'pages') {
                    document.querySelector('.tab-btn:first-child').classList.add('active');
                    document.getElementById('tab-pages').classList.add('active');
                } else {
                    document.querySelector('.tab-btn:last-child').classList.add('active');
                    document.getElementById('tab-lib').classList.add('active');
                }
            }
        },

        /* --- PAGES --- */
        pages: {
            add() {
                if(app.state.pages.length > 0) this.saveCurrent();
                app.state.pages.push({ json: app.canvas.toJSON() });
                this.load(app.state.pages.length - 1);
                this.renderList();
            },
            saveCurrent() {
                app.state.pages[app.state.pageIndex].json = app.canvas.toJSON();
            },
            load(index) {
                if(app.state.pages.length > 0) this.saveCurrent();
                app.state.pageIndex = index;
                app.canvas.loadFromJSON(app.state.pages[index].json, () => {
                    app.canvas.renderAll();
                    app.history.reset();
                    app.tools.set(app.state.tool); // Restore tool
                });
                this.renderList();
            },
            renderList() {
                const list = document.getElementById('page-list');
                list.innerHTML = '';
                app.state.pages.forEach((p, i) => {
                    const el = document.createElement('div');
                    el.className = `page-thumb ${i === app.state.pageIndex ? 'active' : ''}`;
                    el.innerHTML = `<i class="far fa-file"></i> <div class="page-badge">${i+1}</div>`;
                    el.onclick = () => this.load(i);
                    list.appendChild(el);
                });
            }
        },

        /* --- TOOLS --- */
        tools: {
            set(tool) {
                app.state.tool = tool;
                app.canvas.isDrawingMode = false;
                app.canvas.selection = true;
                
                // UI
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById(`btn-${tool}`);
                if(btn) btn.classList.add('active');

                if (tool === 'pen' || tool === 'highlighter') {
                    app.canvas.isDrawingMode = true;
                    app.canvas.selection = false;
                    app.props.refreshBrush();
                } else if (tool === 'eraser') {
                    app.canvas.isDrawingMode = true;
                    app.canvas.freeDrawingBrush = new fabric.PencilBrush(app.canvas);
                    app.canvas.freeDrawingBrush.color = '#ffffff';
                    app.canvas.freeDrawingBrush.width = 40;
                }
            },
            addText() {
                const t = new fabric.IText('Text', { 
                    left: 200, top: 200, fill: app.state.color, fontSize: 40 
                });
                app.canvas.add(t);
                app.canvas.setActiveObject(t);
                this.set('select');
            }
        },

        /* --- PROPERTIES --- */
        props: {
            setColor(hex, el) {
                app.state.color = hex;
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                if(el) el.classList.add('active');
                
                const active = app.canvas.getActiveObject();
                if(active) {
                    active.set({ fill: hex });
                    if(active.type === 'path') active.set({ stroke: hex });
                    app.canvas.renderAll();
                    app.history.save();
                }
                this.refreshBrush();
            },
            setSize(val) {
                app.state.size = parseInt(val, 10);
                this.refreshBrush();
            },
            refreshBrush() {
                if(!app.canvas.freeDrawingBrush) return;
                if(app.state.tool === 'pen') {
                    app.canvas.freeDrawingBrush.color = app.state.color;
                    app.canvas.freeDrawingBrush.width = app.state.size;
                } else if(app.state.tool === 'highlighter') {
                    const c = new fabric.Color(app.state.color);
                    app.canvas.freeDrawingBrush.color = c.setAlpha(0.3).toRgba();
                    app.canvas.freeDrawingBrush.width = app.state.size * 4;
                }
            },
            toggleGrid(active) {
                app.state.isSnapping = active;
                if(active) {
                    // Visual grid
                    const p = document.createElement('canvas'); p.width=30; p.height=30;
                    const ctx = p.getContext('2d');
                    ctx.fillStyle = '#eee'; ctx.fillRect(0,0,1,30); ctx.fillRect(0,0,30,1);
                    app.canvas.setBackgroundColor(new fabric.Pattern({source:p, repeat:'repeat'}), app.canvas.renderAll.bind(app.canvas));
                } else {
                    app.canvas.setBackgroundColor('#ffffff', app.canvas.renderAll.bind(app.canvas));
                }
            }
        },

        /* --- LIBRARY & DRAG DROP --- */
        lib: {
            dragStart(e, type) {
                e.dataTransfer.setData('type', type);
            },
            drop(e) {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                const p = app.canvas.getPointer(e);
                let obj;

                const opts = { left: p.x, top: p.y, fill: app.state.color, originX:'center', originY:'center' };

                if(type === 'rect') obj = new fabric.Rect({ ...opts, width:100, height:100 });
                else if(type === 'circle') obj = new fabric.Circle({ ...opts, radius:50 });
                else if(type === 'triangle') obj = new fabric.Triangle({ ...opts, width:100, height:100 });
                else if(type === 'star') {
                    // Manual star polygon
                    obj = new fabric.Polygon([
                        {x:0,y:-50},{x:15,y:-20},{x:50,y:-20},{x:20,y:5},{x:30,y:40},{x:0,y:20},
                        {x:-30,y:40},{x:-20,y:5},{x:-50,y:-20},{x:-15,y:-20}
                    ], opts);
                } else if(type === 'arrow') {
                    // Simplified arrow
                    obj = new fabric.Path('M 0 10 L 50 10 L 50 20 L 80 0 L 50 -20 L 50 -10 L 0 -10 z', opts);
                }

                if(obj) {
                    app.canvas.add(obj);
                    app.canvas.setActiveObject(obj);
                    app.history.save();
                }
            }
        },

        /* --- CONTEXT MENU ACTIONS --- */
        ctx: {
            target: null,
            open(e, target) {
                e.preventDefault();
                if(!target) return;
                this.target = target;
                
                // Select it if not already
                app.canvas.setActiveObject(target);
                
                const menu = document.getElementById('context-menu');
                menu.style.display = 'flex';
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
            },
            action(act) {
                const t = app.canvas.getActiveObject();
                if(!t) return;
                
                switch(act) {
                    case 'lock':
                        t.set({ lockMovementX:true, lockMovementY:true, lockRotation:true, lockScalingX:true, lockScalingY:true });
                        break;
                    case 'unlock':
                        t.set({ lockMovementX:false, lockMovementY:false, lockRotation:false, lockScalingX:false, lockScalingY:false });
                        break;
                    case 'front': t.bringToFront(); break;
                    case 'back': t.sendToBack(); break;
                    case 'clone':
                        t.clone(cloned => {
                            cloned.set({ left: t.left+20, top: t.top+20 });
                            app.canvas.add(cloned);
                        });
                        break;
                    case 'cloner':
                        // Custom logic: Attach a flag
                        t.isCloner = !t.isCloner;
                        t.set('opacity', t.isCloner ? 0.7 : 1);
                        break;
                    case 'group':
                        if(t.type === 'activeSelection') {
                            t.toGroup();
                            app.canvas.requestRenderAll();
                        }
                        break;
                    case 'ungroup':
                        if(t.type === 'group') {
                            t.toActiveSelection();
                            app.canvas.requestRenderAll();
                        }
                        break;
                }
                app.canvas.renderAll();
                app.history.save();
                document.getElementById('context-menu').style.display = 'none';
            }
        },

        /* --- EVENTS & HISTORY --- */
        bindEvents() {
            // Drag Drop from library
            const wrap = document.getElementById('canvas-wrapper');
            wrap.addEventListener('dragover', e => e.preventDefault());
            wrap.addEventListener('drop', e => app.lib.drop(e));

            // Infinite Cloner Logic
            this.canvas.on('mouse:down', (e) => {
                if(e.target && e.target.isCloner && app.mode !== 'present') {
                    // Create a clone immediately
                    e.target.clone(cloned => {
                        cloned.set({ left: e.target.left, top: e.target.top, isCloner: false, opacity: 1 });
                        app.canvas.add(cloned);
                        app.canvas.setActiveObject(cloned);
                        // Start dragging the new clone
                        cloned._onMouseDown(e.e); 
                    });
                }
            });

            // Context Menu
            this.canvas.on('mouse:down', (e) => {
                if(e.button === 3 || (e.e.button === 2)) { // Right click
                    app.ctx.open(e.e, e.target);
                }
            });
            // Disable native context menu on canvas
            document.querySelector('.upper-canvas').addEventListener('contextmenu', e => e.preventDefault());

            // Snapping
            this.canvas.on('object:moving', (e) => {
                if(app.state.isSnapping) {
                    e.target.set({
                        left: Math.round(e.target.left / 30) * 30,
                        top: Math.round(e.target.top / 30) * 30
                    });
                }
                
                // Trash Can Hover
                const can = document.getElementById('trash-can');
                const p = e.target.getCenterPoint();
                const wrap = document.getElementById('canvas-wrapper');
                // Check if near bottom right
                if(p.x > wrap.clientWidth - 100 && p.y > wrap.clientHeight - 100) {
                    can.classList.add('hover');
                } else {
                    can.classList.remove('hover');
                }
            });

            this.canvas.on('mouse:up', (e) => {
                 const can = document.getElementById('trash-can');
                 if(can.classList.contains('hover')) {
                     const active = app.canvas.getActiveObjects();
                     app.canvas.discardActiveObject();
                     active.forEach(o => app.canvas.remove(o));
                     can.classList.remove('hover');
                     app.history.save();
                 }
            });

            // History Hooks
            this.canvas.on('object:added', () => app.history.save());
            this.canvas.on('object:modified', () => app.history.save());
            this.canvas.on('object:removed', () => app.history.save());
        },

        history: {
            undoStack: [], redoStack: [], processing: false,
            save() {
                if(this.processing) return;
                if(this.undoStack.length > 20) this.undoStack.shift();
                this.undoStack.push(JSON.stringify(app.canvas.toJSON()));
                this.redoStack = [];
            },
            undo() {
                if(!this.undoStack.length) return;
                this.processing = true;
                this.redoStack.push(JSON.stringify(app.canvas.toJSON()));
                app.canvas.loadFromJSON(this.undoStack.pop(), () => {
                    app.canvas.renderAll();
                    this.processing = false;
                    app.props.refreshBrush();
                });
            },
            redo() {
                if(!this.redoStack.length) return;
                this.processing = true;
                this.undoStack.push(JSON.stringify(app.canvas.toJSON()));
                app.canvas.loadFromJSON(this.redoStack.pop(), () => {
                    app.canvas.renderAll();
                    this.processing = false;
                    app.props.refreshBrush();
                });
            },
            reset() { this.undoStack=[]; this.redoStack=[]; }
        },
        
        io: {
            export() {
                app.pages.saveCurrent();
                const json = JSON.stringify({ pages: app.state.pages });
                const blob = new Blob([json], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = 'lesson.json'; a.click();
            },
            import() {
                const input = document.getElementById('file-loader');
                input.onchange = (e) => {
                    const r = new FileReader();
                    r.onload = (res) => {
                        try {
                            const d = JSON.parse(res.target.result);
                            if(d.pages) {
                                app.state.pages = d.pages;
                                app.pages.load(0);
                            }
                        } catch(e) { alert("File error"); }
                    };
                    if(e.target.files[0]) r.readAsText(e.target.files[0]);
                    input.value = '';
                };
                input.click();
            }
        }
    };

    // Boot
    window.onload = () => app.init();

    </script>
</body>
</html>
